on:
  - push
  - pull_request
# this action is shamelessly stolen from plugfox ğŸŒš

jobs:
  test-analyze:
    runs-on: ubuntu-latest
    container:
      image: plugfox/flutter:stable
      options: --user root

    steps:
      - name: ğŸš‚ Get latest code
        uses: actions/checkout@v2

      - name: Git configure
        run: |
          git config --global --add safe.directory /opt/flutter

      - name: ğŸšƒ Cache pub modules
        uses: actions/cache@v2
        env:
          cache-name: cache-blaze-pub
        with:
          path: |
            $PWD/.pub_cache/
          key: ${{ runner.os }}-blaze

      - name: ğŸ—„ï¸ Export pub cache directory
        run: export PUB_CACHE=$PWD/.pub_cache/

      - name: ğŸ‘· Install Dependencies
        timeout-minutes: 1
        run: flutter pub get

      - name: ğŸ” Check format
        timeout-minutes: 1
        run: |
          dart format --set-exit-if-changed -l 80 -o none .

      - name: ğŸ§ª Run tests
        timeout-minutes: 2
        run: |
          dart run coverage:test_with_coverage -fb -o coverage -- \
            --concurrency=6 --platform vm --coverage=./coverage --reporter=expanded test/isolation_test.dart          
      
      - name: ğŸ“ˆ Check analyzer
        timeout-minutes: 1
        run: dart analyze --fatal-infos --fatal-warnings lib

      - name: ğŸ¥² run tests
        run: |
          flutter test

      - name: ğŸ“¥ Upload coverage to Codecov
        timeout-minutes: 1
        uses: codecov/codecov-action@v2.1.0
    